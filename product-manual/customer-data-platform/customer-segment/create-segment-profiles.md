---
id: create-segment-profiles
sidebar_position: 2
---

# 创建用户群体

在 **项目 > 用户洞察 > 群体画像** 中点击 **新建群体画像** 进入群体画像创建弹窗，选择创建方式后进入群体画像创建流程。

![图 17](/img/d51304f7080daf7ae9a913013182de95bd042d2e671d63eb62900918a6a9b073.png)

## 标签创建

在 **新建群体画像** 弹窗中选择 **标签圈群** 后进入标签圈群弹窗。

### 控件说明

- 基础信息

| 项       | 是否必填 | 说明                                       | 限制条件                                                                                    |
| -------- | -------- | ------------------------------------------ | ------------------------------------------------------------------------------------------- |
| 名称     | 是       | 群体画像名称                               | 名称 **项目内** 唯一，不可重复<br/>最大输入 30 个字符                                       |
| 标识符   | 是       | 群体画像标识符<br/>可用于数据库和 API 查询 | 名称 **全局** 唯一，不可重复<br/>最大输入 100 个字符<br/>仅允许大小写英文、数字、以及下划线 |
| 描述     | 否       | 群体画像的业务意义描述                     | 最大输入 150 个字符                                                                         |
| 更新频次 | 是       | 群体画像更新计算周期                       | 仅支持选择每日更新和自动更新                                                                |

![图 18](/img/67c5c771ce6d821e2d9f84ccdbf19154e18f9985bd14d4e8b672d3b994bd70e6.png)

- 定义规则

群体画像支持根据 **用户特征** 创建用户群体

> 注：最多支持 10 条定义规则

#### 用户特征

| 项             | 说明                                                                       | 限制条件                             |
| -------------- | -------------------------------------------------------------------------- | ------------------------------------ |
| 属性选择器     | 选择用户特征                                                               | 支持选择用户身份、用户属性和用户标签 |
| 过滤选择器     | 选择用户特征过滤条件                                                       | 无                                   |
| 标签数据选择器 | 选择用户标签计算结果，可选择最新结果或某一天的历史结果。默认选择最新结果。 | 无                                   |

> 注：需要在“标签存储”中开启标签历史结果存储功能，该标签才能选择历史数据

![](/img/用户洞察-群体画像-规则创建-定义规则-用户属性.png)

#### 预估人数

在群体画像保存前，建议点击 **计算** 预估群体人数，以确定定义规则和业务预期是否一致。

### 统计逻辑

#### 例 1：用户属性性别为男

![](/img/用户洞察-群体画像-规则创建-例3.png)

```sql
select
	gio_id 								    as gio_id
from olap.user
where usr_gender = '男'
```

## 行为圈群

在 **新建群体画像** 弹窗中选择 **行为圈群** 后进入行为创建弹窗。

### 控件说明

- 基础信息 同标签圈群

- 定义规则 群体画像支持根据 **用户行为** 创建用户群体

> 注：最多支持 10 条定义规则

#### 用户行为 - 做过

| 项              | 说明                       | 限制条件                                                |
| --------------- | -------------------------- | ------------------------------------------------------- |
| 时间选择器      | 选择事件发生时间           | 无                                                      |
| 事件选择器      | 选择事件                   | 支持埋点事件和虚拟事件                                  |
| 维度+度量选择器 | 选择事件计算逻辑           | 支持选择次数总和<br/>支持选择整数、小数类型事件属性总和 |
| 行为条件选择器  | 选择事件计算结果的筛选条件 | 无                                                      |
| 过滤选择器      | 选择事件过滤条件           | 支持选择事件属性、用户属性和用户标签                    |

![](/img/用户洞察-群体画像-规则创建-定义规则.png)

#### 用户行为 - 未做过

| 项         | 说明             | 限制条件                             |
| ---------- | ---------------- | ------------------------------------ |
| 时间选择器 | 选择事件发生时间 | 无                                   |
| 事件选择器 | 选择事件         | 支持埋点事件和虚拟事件               |
| 过滤选择器 | 选择事件过滤条件 | 支持选择事件属性、用户属性和用户标签 |

![](/img/用户洞察-群体画像-规则创建-定义规则-未做过.png)

### 统计逻辑

#### 例 1：做过订单支付事件金额总和大于 1 万元

![](/img/用户洞察-群体画像-规则创建-例1.png)

```sql
select
	u.gio_id 								as gio_id
from
(
	select
		gio_id 								as gio_id
	from olap.user
	where usr_$first_day is not null
) u  															-- 全量用户
join
(
	select
	    gio_id                          	as gio_id
	    ,sum( var_payamount )				as payamount
	from olap.event
	where account_id = 'bc675c65b3b0290e'                       -- 项目ID
	    and dateDiff( 'day' , dt , today()) between 1 and 30    -- 时间筛选
	    and event_key = 'payment'                             	-- 事件标识符
	group by gio_id
	having payamount > 10000
) e on u.gio_id = e.gio_id
```

#### 例 2：未做过使用优惠券的订单支付事件

![](/img/用户洞察-群体画像-规则创建-例2.png)

以上规则计算结果包含以下用户群体：

- 过去 30 天未活跃(未发生任意行为)的用户

- 过去 30 天活跃但未发生订单支付的用户

- 过去 30 天活跃且发生订单支付，但未使用优惠券的用户

> 当使用未做过时，计算结果可能会包含大量“沉睡用户”，建议先进行人群预估再进行保存

```sql
select
	u.gio_id 								as gio_id
from
(
	select
		gio_id 								as gio_id
	from olap.user
	where usr_$first_day is not null
) u  															-- 全量用户
left join
(
	select
	    gio_id                          	as gio_id
	    ,count(1)                           as num
	from olap.event
	where account_id = 'bc675c65b3b0290e'                       -- 项目ID
	    and dateDiff( 'day' , dt , today()) between 1 and 30    -- 时间筛选
	    and event_key = 'payment'                             	-- 事件标识符
        and var_E_ifCounpon = '是'
	group by gio_id
) e on u.gio_id = e.gio_id
where e.num is null or e.num = 0
```

## 行为序列圈群

在 **新建群体画像** 弹窗中选择 **行为序列圈群** 后进入行为序列圈群弹窗。

### 控件说明

- 基础信息 同标签圈群

- 定义规则 群体画像支持根据 **用户行为序列** 创建用户群体

> 注：最多支持 10 条定义规则

#### 行为序列 - 用户进入行为序列后，在规定的时间范围，按照分析者规定的行为，依次完成了目标事件。

| 项           | 说明                       | 限制条件                             |
| ------------ | -------------------------- | ------------------------------------ |
| 时间选择器   | 选择事件发生时间           | 无                                   |
| 事件选择器   | 选择事件                   | 支持埋点事件和虚拟事件               |
| 过滤选择器   | 选择事件过滤条件           | 支持选择事件属性、用户属性和用户标签 |
| 行为序列窗口 | 选择行为序列完成的时间窗口 | 支持设置天、小时、分钟级别的窗口     |

> 注：行为序列窗口指用户行为从第一步到完成之后每一步需要在转化周期时长内完成记作转化，否则记作流失。 比如，转化周期设置为 7 天，是指用户完成序列第一步之后，需要在后续的 7 天内完成序列的最后一步才计算进群组内，否则会记为流失。

![图 19](/img/bf528a6908eee3aae45d3fc05531de59440b969c54f0c595a272046fadaf299f.png)

### 统计逻辑

#### 例 1：近 30 天内依次完成了浏览、加购、购买行为的用户

![图 19](/img/bf528a6908eee3aae45d3fc05531de59440b969c54f0c595a272046fadaf299f.png)

```sql
SELECT gio_id,
tupleElement(arrayJoin(xFunnel(604800)((client_time),
(event_key = '$page' AND (platform = 'ios')) AND
event_time < '2022-09-27',
(event_key = 'add_to_cart'),
(event_key = 'purchase'))),
1) AS level
FROM space_1_event_view
WHERE (event_time >= '2022-08-28' AND
event_time < '2022-10-04')
AND (((event_key = '$page' AND (platform = 'ios')) OR
(event_key = 'add_to_cart') OR
(event_key = 'purchase')))
GROUP BY gio_id
HAVING (level >= 3)
```

## 群组圈群

在 **新建群体画像** 弹窗中选择 **群组圈群** 后进入群组圈群弹窗。

### 控件说明

- 基础信息 同标签圈群

- 定义规则 群体画像支持根据已经计算好的 **已有群组** 结果，进行二次组合，创建用户群体

> 注：最多支持 10 条定义规则

#### 已有人群

| 项         | 说明     | 限制条件 |
| ---------- | -------- | -------- |
| 群组选择器 | 选择群组 | 无       |

> 注：选择已有人群进行计算时，仅使用圈选后的结果；不会直接根据原人群包规则进行重新运算

![图 22](/img/d47109859355219aece1d3d14140f5160f39ad36d4632039f31c1e91192246d2.png)

### 统计逻辑

#### 例 1：将 上传人群 A 和 来自 MA 防流失人群 进行合并，生成一个新的营销人群

![图 25](/img/d6fd554b5a8aad768f19499e9ea913011888c5aa3e0436d5fa99b4b40c88e4d6.png)

```sql
SELECT gio_id AS term0
FROM space_1_user_view
WHERE seg_csqr = '1'
OR seg_lzMAflsrq_5c = '1'
```

## 组合圈群

在 **新建群体画像** 弹窗中选择 **组合圈群** 后进入组合圈群弹窗。

> 注：在组合圈群方式下，可同时使用标签圈群、行为圈群、行为序列圈群、已有群组 4 种方式进行灵活组合。

## 上传群组

在 **新建群体画像** 弹窗中选择 **上传群组** 后进入上传群组弹窗。

### 控件说明

- 基础信息

| 项       | 是否必填 | 说明                                       | 限制条件                                                                                    |
| -------- | -------- | ------------------------------------------ | ------------------------------------------------------------------------------------------- |
| 名称     | 是       | 群体画像名称                               | 名称 **项目内** 唯一，不可重复<br/>最大输入 30 个字符                                       |
| 标识符   | 是       | 群体画像标识符<br/>可用于数据库和 API 查询 | 名称 **全局** 唯一，不可重复<br/>最大输入 100 个字符<br/>仅允许大小写英文、数字、以及下划线 |
| 描述     | 否       | 群体画像的业务意义描述                     | 最大输入 150 个字符                                                                         |
| 更新频次 | 是       | 群体画像更新计算周期                       | 仅支持选择手动更新                                                                          |

![](/img/用户洞察-群体画像-文件上传.png)

- 定义规则

| 项       | 是否必填 | 说明                   | 限制条件                           |
| -------- | -------- | ---------------------- | ---------------------------------- |
| 匹配字段 | 是       | 用于上传的用户匹配字段 | 支持选择全部用户身份和特定用户属性 |
| 上传文件 | 是       | 匹配文件               | 仅支持 csv 格式<br/>最大支持 20M   |

![](/img/用户洞察-群体画像-文件上传-定义规则.png)

### 统计逻辑

- 仅支持匹配上传文件的第一列

- 仅支持匹配系统中存在的用户，对于未识别的用户不会进行用户创建

```sql
select
    u.gio_id                                    as gio_id
from
(
    select
        gio_id 								    as gio_id
        ,{匹配字段}                              as match_value
    from olap.user
    where usr_$first_day is not null
) u
join
(
    select
        distinct first_column                   as first_column
    from file
) f on u.match_value = f.first_column
```

## 常见问题

### 问题 1：“负向条件“计算逻辑

2.3 以下版本对于“负向条件”计算逻辑与 2.3 及以上版本存在差别，具体说明如下。

负向条件定义：

- 做过 事件 次数｜事件属性-求和 = 0

- 做过 事件 次数｜事件属性-求和 < N

- 做过 事件 次数｜事件属性-求和 <= N

当群体画像定义规则为以下两种形式时：

1. 全部规则均为“负向条件”

2. 不包含且规则，且至少包含一条“负向条件”

群体画像计算逻辑会默认增加一个且规则。规则为“负向条件”所选时间范围内，用户做过任意事件次数 > 0。

#### 例 1：做过 过去 30 天 订单支付事件次数 = 0

- 2.3 以下版本计算逻辑

做过 过去 30 天 任意事件次数 > 0
且
未做过 过去 30 天 订单支付事件

- 2.3 及以上版本计算逻辑

做过 过去 30 天 订单支付事件次数 = 0

```sql
select
	u.gio_id 								as gio_id
from
(
	select
		gio_id 								as gio_id
	from olap.user
	where usr_$first_day is not null
) u  															-- 全量用户
join
(
	select
	    gio_id                          	as gio_id
	    ,count(1)							as num
	from olap.event
	where account_id = 'bc675c65b3b0290e'                       -- 项目ID
	    and dateDiff( 'day' , dt , today()) between 1 and 30    -- 时间筛选
	    and event_key = 'payment'                             	-- 事件标识符
	group by gio_id
	having num > 0
) e on u.gio_id = e.gio_id
```

#### 例 2：做过 过去 30 天 订单支付事件次数 < N

- 2.3 以下版本计算逻辑

做过 过去 30 天 任意事件次数 > 0
且
(
未做过 过去 30 天 订单支付事件
或
做过 过去 30 天 订单支付事件次数 < N
)

- 2.3 及以上版本计算逻辑

做过 过去 30 天 订单支付事件次数 < N

> 不包含过去 30 天未做过订单支付事件的用户

#### 例 3：做过 过去 30 天 订单支付事件次数 <= N

- 2.3 以下版本计算逻辑

做过 过去 30 天 任意事件次数 > 0
且
(
未做过 过去 30 天 订单支付事件
或
做过 过去 30 天 订单支付事件次数 <= N
)

- 2.3 及以上版本计算逻辑

做过 过去 30 天 订单支付事件次数 <= N

> 不包含过去 30 天未做过订单支付事件的用户![图 20](/img/f6cd853032a47164fd51f57e44f4339b4f03da04bcda23c3aaab157c0fcf00b3.png)
