---
id: virtual-property
sidebar_position: 5
---

# 虚拟属性

## 简介

虚拟属性，是指在数据入库之后通过 SQL 表达式对已定义的属性进行二次加工，产生一个新的属性值。

虚拟属性作为GrowingIO推出的高级能力，涉及到较多技术细节，适用于SQL经验较强的用户参考。若对文档有疑问或使用上遇到问题，请及时联系GrowingIO的技术支持。

## 功能边界或约束

- 支持创建事件的虚拟属性，暂不支持创建用户和维度表的虚拟属性
- 支持引用事件属性来创建事件的虚拟属性，暂不支持引用用户属性和维度表字段
- 支持创建字符串类型的虚拟属性
- 考虑到性能等因素的影响，虚拟属性开放了常规的函数供使用，支持的函数范围见附录

## 功能说明

虚拟属性管理的入口：【客户数据平台】 - 【事件管理】 - 【虚拟属性】

![picture 1](/img/d8353d20ee5866e890fe2d13f56848164a5cdb690815711fc47f2bd4284b357f__2021-12-09.png)  

### 创建虚拟属性

创建一个虚拟属性，分两个步骤。

**步骤 一：设置虚拟属性基本信息** 

![设置虚拟属性基本信息](/img/cdb2f390a3d8f927d172f861f867f974d1f6ee53ab393a23e09caf260c666c1f_pic_1640332296990_2021-12-24.png)  

| 表单字段 | 含义及约束条件 |
|--------|--------|
| 名称 | 虚拟属性的显示名，限长30个字符，且不能与事件属性重复。   |
| 标识符 | 虚拟属性的标识符，限长100个字符，且不能与事件属性重复。   |
| 类型 | 数据类型，可选值：字符串、整数、小数。默认值：字符串。   |
| 全局属性 | 绑定事件的方式，默认“否”。当选择“是”时，默认绑定到所有事件上。   |
| 描述 | 虚拟属性的描述，限长150个字符。   |
| 关联维度表 | 将需要应用到分析工具的维度表关联到指定的虚拟属性上。   |


**步骤 二：定义规则（虚拟属性的SQL表达式）**

![定义规则](/img/2d251305c588d2bf7cdb582d6f60d1ce2c192565ce179473d7b0ee8c32c09c81_pic_1640332353311_2021-12-24.png)  


SQL表达式细则：

- 引用的属性为事件属性的标识符
- 支持的函数范围及示例见附录

### 修改虚拟属性

对于已创建的虚拟属性，支持您再次编辑。

具体操作是点击某行虚拟属性，在详情页中点击“编辑”按钮，即可进入编辑弹窗。

![修改虚拟属性](/img/041fa820f2391eb608b782d40980fde535cbec217a3710272309c6be8428b57d_pic_1640332394567_2021-12-24.png)  

### 删除虚拟属性

对于已创建的虚拟属性，如果没有用或没有用到，您可以将其删除。

具体操作是点击某虚拟属性行的操作列，弹窗的删除按钮点击后即可删除该虚拟属性。

![删除虚拟属性](/img/e38d6a450744d578c7d1a47de984119223122fbc2d3c9aed7989849843876c82_pic_1640332452224_2021-12-24.png)  

提示：删除虚拟属性将影响到使用它的单图等应用。

### 虚拟属性绑定到事件上

对于已创建的虚拟属性，要想在分析工具中使用它，需将其绑定到需要分析的事件上。

绑定操作在【客户数据平台】 - 【事件管理】 - 【埋点事件】中。

![绑定虚拟属性到事件](/img/cfd7de745bec4104a79830a22a2a0617f486442fc63a08c3e70d9b5e901f4c79_pic_1640332502006_2021-12-24.png)  


### 虚拟属性绑定到所有事件
当创建虚拟属性时，如果它引用的事件属性全部来源于预定义的事件属性，这时要把它绑定到所有事件上时，不必逐个事件一一绑定，只需要将该虚拟属性的“全局属性”类型设置为“是”即可。
![虚拟属性全局绑定](/img/虚拟属性_全局属性.png) 

## 应用案例

### 案例 1：属性数据类型转换

假设某埋点属性为订单价格（price_1，数值类型），希望精度保留到百位（向下取整）且转为字符串类型，以便于用它来做下钻分析。

SQL表达式： to_string(floor(price_1/100)*100)
​
### 案例 2：属性大小写转换

假设某埋点属性（name）上报值中有大小写混合的字符串，比如GrowingIO和growingio，在下钻分析时希望统计为一条growingio，这时可以创建一个新的虚拟属性来表达。

SQL表达式： lower(name)
​
### 案例 3：属性内容提取

假设我们埋点了一个事件属性url，希望从url中提取出参数arg的值用来做下钻分析，那么可以创建一个新的虚拟属性来表达。

​比如：url的值为 http://test.com/test?arg=渠道1

SQL表达式： parse_url_query(url,'arg')

返回值为：渠道1

​
### 案例 4：属性内容拼接

假设分析时，需要将多个字符串属性的值拼接在一起，合并成一个属性在分析图表中做下钻分析或筛选过滤，这时您可以创建一个新的虚拟属性来表达。

比如有属性A（var_1，字符串类型）、B（var_2，字符串类型）和（var_3，字符串类型），需要用分隔符“-”拼在一起

SQL表达式：concat(var_1 , '-' , var_2 , '-' , var_3)

### 案例 5：属性计算

假设订单事件在埋点时埋了两个属性：商品的进货价（price_1，数值类型）和出货价（price_2，数值类型），当我们想计算每个商品的进货价和出货价的差值，可以创建一个新的虚拟属性为利润（income）来表达。

SQL表达式：price_2 - price_1

### 案例 6：属性字典翻译

假设埋点时，某属性（var_1，字符串类型）上报时值为英文，属性值为可枚举。希望它在看板分析重展示时映射为中文，可以创建一个新的虚拟属性来表达。

| 属性值 | 翻译值 |
|--------|--------|
| level1 | 初级   |
| level2 | 中级   |
| level3 | 高级   |

SQL表达式：

case 
when var_1 = 'level1' then '初级' 
when var_1 = 'level2' then '中级'
when var_1 = 'level3' then '高级' 
else '其他等级' end
​
## 常见问题

### Q：虚拟属性可以在用户属性中创建吗？

A：目前不支持基于用户属性的虚拟属性创建，如果相关场景，您可以考虑通过新建用户属性+数据导入的方式获得所需属性值。
​
### Q：虚拟属性可以跨域引用属性吗？比如事件虚拟属性引用用户属性

A：考虑性能影响，目前虚拟属性的SQL表达式，不支持引用跨域的属性。
​
### Q：虚拟属性对查询性能的影响大吗？

A：虚拟属性由于不支持跨域引用属性，很大程度上规避了给统计图表带来性能降低的问题。大部分的虚拟属性对性能的影响几乎可以忽略，比如属性的计算、类型转换等；少量函数比如正则匹配，对使用它的单图的查询性能下降30%左右。

### Q：虚拟属性引用的属性被删除，虚拟属性还能正常使用吗？

A：当引用的属性被删除时，虚拟属性立即变为异常状态。对于使用了异常的虚拟属性的单图将受到影响。

## 附录

### 虚拟属性支持的函数范围
| 函数            | 含义            | 示例                                                                                                                                                               |
|-----------------|-----------------|--------------------------------------------------------------------------------------------------------------------------------------------------------------------|
| like            | 模糊查询        | 假设属性var_1值为GrowingIO，需要提取出包含Growing的值<br/>SQL表达式：var_1 like '%Growing%'                                                                        |
| regexp          | 正则匹配        | 假设属性var_1值为GrowingIO，需要提取出包含G开头的值<br/>SQL表达式：var_1 regexp '^G'                                                                               |
| round           | 四舍五入        | 假设属性var_1为数值类型<br/>SQL表达式：round(var_1)                                                                                                                |
| floor           | 向下取整        | 假设属性var_1为数值类型<br/>SQL表达式：floor(var_1)                                                                                                                |
| ceill           | 向上取整        | 假设属性var_1为数值类型<br/>SQL表达式：ceil(var_1)                                                                                                                 |
| if              | 条件判断        | 假设var_1为数值类型<br/>SQL表达式：if(var_1>=100, 'VIP', '普通会员')                                                                                               |
| if_null         | 判断空判断      | 假设var_1为字符串类型，值域范围为：NULL, 男，希望NULL值转化为“女”<br/>SQL表达式：if_null(var_1, '女')                                                              |
| coalesce        | 非空查找        | 查找多个属性中的非空首个值<br/>SQL表达式： coalesce(var_1, var_2, var_3)                                                                                           |
| case when       | Case函数        | 假设var_1为数值类型<br/>SQL表达式：<br/>case<br/>when var_1>=1000 then 'A级'<br/>when var_1>=100 then 'B级' <br/>when var_1>=10 then 'C级'<br/>else '其他'<br/>end |
| length          | 字符串/列表长度 | 假设var_1为字符串类型<br/>SQL表达式：length(var_1)                                                                                                                 |
| concat          | 字符串拼接      | 假设var_1, var_2为字符串类型<br/>SQL表达式：concat(var_1, var_2)<br/>备注：支持两个及以上的字符串拼接                                                              |
| replace         | 字符串替换      | 假设var_1为字符串类型，值为GrowingIO，需要把IO替换为Hello<br/>SQL表达式：replace(var_1, 'IO' , 'Hello')                                                            |
| substring       | 字符串提取      | 假设var_1为字符串类型，值为GrowingIO，需要提取前3个字符<br/>SQL表达式：substring(var_1, 1, 3)                                                                      |
| upper           | 字符串转大写    | upper(var_1)                                                                                                                                                       |
| lower           | 字符串转小写    | lower(var_1)                                                                                                                                                       |
| parse_url_query | URL参数提取     | 假设var_1为URL链接的字符串，需要提取链接中参数为arg的值<br/>SQL表达式：parse_url_query(var_1, 'arg')                                                               |
| to_string       | 转字符串类型    | 假设var_1为数值型<br/>SQL表达式：to_string(var_1)                                                                                                                  |
| to_int          | 转整型          | 假设var_1为字符串类型的数值<br/>SQL表达式：to_int(var_1)                                                                                                           |
| to_float        | 转小数          | 假设var_1为字符串类型的数值<br/>SQL表达式：to_float(var_1)                                                    | 
| to_date         | 字符串转日期 | 假设var_1为字符串类型，如"2022-01-01"<br/>SQL表达式：to_date(var_1) |
| format_date     | 日期格式化 | 如将event_time转小时，<br/>SQL表达式：format_date(event_time,'%H')  |


format_date的常用修饰符如下：

| 修饰符 | 描述 | 示例 |
|-----------------|-----------------|-----------------|
| %Y | 年 | 2018 |
| %y | 年份，最后两位数字（00-99) | 18 |
| %m | 月份，零填充（01-12) | 01 |
| %d | 月中的一天，零填充（01-31) | 02 |
| %e | 月中的一天，无零填充（1-31) | 2 |
| %H | 24小时格式（00-23) | 22 |
| %I | 小时12h格式（01-12) | 10 |
| %M | 分钟(00-59) | 33 |
| %w | 周中第几天，周日为0(0-6) | 2 |
                                                     |
